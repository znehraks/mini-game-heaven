# claude-symphony Auto-Checkpoint Configuration
# Automatic checkpoint creation and management

auto_checkpoint:
  enabled: true
  description: "Automatic checkpoint creation and management"

  # Trigger conditions
  triggers:
    # Task completion based
    task_based:
      enabled: true
      condition: "tasks_completed"
      threshold: 5  # Every 5 tasks completed
      action: "create_checkpoint"
      naming: "auto_task_{{count}}_{{timestamp}}"

    # File change based
    file_change_based:
      enabled: true
      condition: "major_file_change"
      threshold: 100  # 100+ lines changed
      action: "create_checkpoint"
      naming: "auto_change_{{timestamp}}"

      # File type weights
      file_weights:
        "*.ts": 1.0
        "*.tsx": 1.0
        "*.js": 1.0
        "*.jsx": 1.0
        "*.py": 1.0
        "*.yaml": 0.5
        "*.json": 0.5
        "*.md": 0.3

    # Before destructive operations
    before_destructive:
      enabled: true
      condition: "destructive_action_detected"
      patterns:
        - "rm -rf"
        - "git reset --hard"
        - "drop table"
        - "DELETE FROM"
        - "truncate"
      action: "force_checkpoint"
      naming: "pre_destructive_{{timestamp}}"
      require_confirmation: true

    # Time based
    time_based:
      enabled: true
      condition: "interval"
      interval_minutes: 30
      action: "create_checkpoint"
      naming: "auto_interval_{{timestamp}}"
      only_if_changes: true  # Only when there are changes

    # Stage based
    stage_based:
      enabled: true
      conditions:
        on_stage_start: false
        on_stage_complete: true
        on_stage_error: true
      action: "create_checkpoint"
      naming: "stage_{{stage_id}}_{{status}}_{{timestamp}}"

  # Retention policy
  retention:
    max_checkpoints: 20
    max_age_days: 30

    cleanup_strategy: "keep_milestones"

    milestone_criteria:
      - stage_complete
      - pre_destructive
      - user_created
      - tagged

    # Auto cleanup
    auto_cleanup:
      enabled: true
      schedule: "daily"
      preserve_minimum: 5

  # Checkpoint content
  checkpoint_content:
    include:
      - source_code: true
      - config_files: true
      - state_files: true
      - handoffs: true
      - outputs: true

    exclude:
      - "node_modules/"
      - ".git/"
      - "*.log"
      - "*.tmp"
      - "__pycache__/"
      - ".cache/"

    # Metadata
    metadata:
      - timestamp
      - stage_id
      - task_count
      - trigger_reason
      - file_changes_summary
      - git_commit_hash

  # Storage settings
  storage:
    base_path: "state/checkpoints/"
    format: "tar.gz"  # tar.gz, zip, directory
    compression_level: 6  # 1-9

    naming_convention: "{{stage}}_{{trigger}}_{{timestamp}}"

    # External storage backup (optional)
    external_backup:
      enabled: false
      provider: null  # s3, gcs, azure
      path: null

# Checkpoint creation process
creation_process:
  steps:
    - name: "validate_state"
      description: "Validate current state"
      required: true

    - name: "collect_files"
      description: "Collect files to include"
      required: true

    - name: "generate_metadata"
      description: "Generate metadata"
      required: true

    - name: "create_archive"
      description: "Create archive"
      required: true

    - name: "verify_integrity"
      description: "Verify integrity"
      required: true

    - name: "cleanup_old"
      description: "Clean up old checkpoints"
      required: false

  # Failure handling
  on_failure:
    retry: 2
    fallback: "skip_with_warning"
    notify: true

# Notification settings
notifications:
  on_create:
    enabled: true
    message: "Checkpoint created: {{name}}"

  on_cleanup:
    enabled: true
    message: "Old checkpoints cleaned up: {{count}} items"

  on_threshold:
    enabled: true
    threshold: 15  # When exceeding 15
    message: "You have {{count}} checkpoints. Cleanup may be needed."

# Git integration
git_integration:
  tag_checkpoints: true
  tag_prefix: "checkpoint/"

  commit_message_template: |
    chore(checkpoint): Auto-checkpoint {{trigger}}

    Stage: {{stage_id}}
    Trigger: {{trigger_reason}}
    Files: {{file_count}}

  push_tags: false  # Push tags to remote if true
