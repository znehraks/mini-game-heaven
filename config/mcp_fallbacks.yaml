# MCP Fallback Configuration
# claude-symphony MCP tool fallback settings (Issue #3 resolution)

mcp_fallbacks:
  # Enable/disable
  enabled: true

  # Fallback trigger conditions
  triggers:
    - quota_exceeded       # Quota exceeded
    - service_unavailable  # Service unavailable
    - timeout              # Timeout
    - rate_limited         # Rate limited

# Search tool priority
search:
  # Code/documentation search
  code_documentation:
    primary: "context7"
    fallbacks:
      - "exa"
      - "web_search"

    # Fallback rules
    rules:
      on_quota_exceeded: "use_fallback"
      on_timeout: "retry_then_fallback"
      retry_count: 2
      retry_delay_ms: 1000

  # Web search
  web_search:
    primary: "exa"
    fallbacks:
      - "web_search"

    rules:
      on_quota_exceeded: "use_fallback"
      on_timeout: "use_fallback"

  # Reddit/community search
  community:
    primary: "exa"
    fallbacks:
      - "web_search"

    # Community search specific settings
    settings:
      include_domains:
        - "reddit.com"
        - "news.ycombinator.com"
        - "dev.to"
        - "stackoverflow.com"

# Browser/web tool priority
browser:
  primary: "playwright"
  fallbacks:
    - "chrome-devtools"

  rules:
    on_connection_failed: "use_fallback"

# Notion tool (no fallback)
notion:
  primary: "notion"
  fallbacks: []

  # Notion has no fallback, notify only on error
  on_error:
    action: "notify_user"
    message: "Notion connection failed. Check MCP settings."

# Figma tool (no fallback)
figma:
  primary: "figma-dev-mode"
  fallbacks: []

  on_error:
    action: "notify_user"
    message: "Figma connection failed. Check Dev Mode MCP settings."

# Stage-specific MCP priority
stage_preferences:
  "01-brainstorm":
    search: ["exa", "web_search"]  # Web research focused
    reason: "Exa preferred for community/idea search"

  "02-research":
    search: ["context7", "exa", "web_search"]
    reason: "Context7 preferred for technical documentation search"

  "03-planning":
    search: ["context7", "exa"]
    reason: "Architecture pattern/documentation search"

  "04-ui-ux":
    browser: ["figma-dev-mode", "playwright"]
    search: ["exa", "web_search"]
    reason: "UI reference search"

  "06-implementation":
    search: ["context7"]
    reason: "Context7 required for library documentation search"

  "09-testing":
    browser: ["playwright", "chrome-devtools"]
    reason: "Playwright required for E2E testing"

# Status monitoring
monitoring:
  # Quota warning
  quota_warning:
    threshold_percent: 80
    action: "warn_user"

  # Usage logging
  usage_logging:
    enabled: true
    log_file: "state/mcp_usage.log"

# Error handling
error_handling:
  # When all fallbacks fail
  all_fallbacks_failed:
    action: "notify_user_and_continue"
    message: |
      All MCP search tools have failed.
      - Proceed with manual search or
      - Check MCP server status.

  # Fatal error
  fatal_error:
    action: "save_state_and_notify"
    message: "MCP fatal error. Save state and restart session."

# =============================================================================
# AI Model Fallback Settings (External AI: Gemini, Codex)
# =============================================================================
ai_model_fallbacks:
  enabled: true
  description: "Auto-fallback to ClaudeCode when external AI CLI fails"

  # Fallback trigger conditions
  triggers:
    - cli_not_installed    # CLI not installed
    - authentication_failed # Authentication failed
    - api_timeout          # API timeout
    - rate_limited         # Rate limited
    - service_error        # Service error

  # Stage-specific AI fallback settings
  stage_fallbacks:
    "01-brainstorm":
      primary: "gemini"
      fallback: "claudecode"
      fallback_reason_template: "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"

    "03-planning":
      primary: "gemini"
      fallback: "claudecode"
      fallback_reason_template: "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"

    "04-ui-ux":
      primary: "gemini"
      fallback: "claudecode"
      fallback_reason_template: "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"

    "07-refactoring":
      primary: "codex"
      fallback: "claudecode"
      fallback_reason_template: "Codex CLI call failed: {{ERROR}} - Fallback to ClaudeCode"

    "09-testing":
      primary: "codex"
      fallback: "claudecode"
      fallback_reason_template: "Codex CLI call failed: {{ERROR}} - Fallback to ClaudeCode"

  # Fallback behavior settings
  behavior:
    # Auto fallback enabled
    auto_fallback: true

    # Retry settings
    retry:
      enabled: true
      max_attempts: 2
      delay_ms: 3000

    # Show warning before fallback
    show_warning_before_fallback: true
    warning_message: |
      External AI {{PRIMARY_MODEL}} call failed
      - Error: {{ERROR_MESSAGE}}
      - Fallback: Continuing with {{FALLBACK_MODEL}}

  # Fallback logging (included in HANDOFF.md)
  logging:
    enabled: true
    log_file: "state/ai_fallback.log"
    include_in_handoff: true

    # Recording format
    format:
      timestamp: true
      stage: true
      intended_model: true
      fallback_model: true
      error_reason: true
      result: true

    # HANDOFF.md fallback section template
    handoff_template: |
      ### Fallback Log

      | Attempted AI | Failure Time | Error | Fallback AI | Result |
      |--------------|--------------|-------|-------------|--------|
      {{#each FALLBACK_EVENTS}}
      | {{this.attempted_model}} | {{this.failure_time}} | {{this.error}} | {{this.fallback_model}} | {{this.result}} |
      {{/each}}

# Pre-run check script integration
pre_run_check:
  enabled: true
  script: "scripts/pre-run-check.sh"

  # Check items
  checks:
    - name: "gemini_cli"
      command: "which gemini"
      on_failure: "warn"
      message: "Gemini CLI not installed - ClaudeCode fallback expected for stages 01, 03, 04"

    - name: "codex_cli"
      command: "which codex"
      on_failure: "warn"
      message: "Codex CLI not installed - ClaudeCode fallback expected for stages 07, 09"

    - name: "tmux"
      command: "which tmux"
      on_failure: "error"
      message: "tmux not installed - External AI calls not possible"

    - name: "gemini_wrapper"
      command: "test -x scripts/gemini-wrapper.sh"
      on_failure: "warn"
      message: "gemini-wrapper.sh not executable"

    - name: "codex_wrapper"
      command: "test -x scripts/codex-wrapper.sh"
      on_failure: "warn"
      message: "codex-wrapper.sh not executable"
