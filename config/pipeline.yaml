# claude-symphony Pipeline Configuration
# Multi-AI Development Workflow Pipeline Definition

pipeline:
  name: "Multi-AI Development Workflow"
  version: "1.0.0"
  description: "10-stage software development workflow with multi-AI orchestration"

stages:
  - id: "01-brainstorm"
    name: "Brainstorming"
    description: "Divergent idea generation and requirements exploration"
    models: ["gemini", "claudecode"]
    mode: "yolo"
    container: true
    inputs:
      - "project_brief.md"
      - "user_requirements.md"
    outputs:
      - "ideas.md"
      - "requirements_analysis.md"
      - "HANDOFF.md"
    timeout: 3600  # 1 hour

  - id: "02-research"
    name: "Research"
    description: "Technical research and market analysis"
    models: ["claude"]
    mode: "plan"
    mcp_servers: ["firecrawl", "exa", "context7"]
    inputs:
      - "requirements_analysis.md"
    outputs:
      - "tech_research.md"
      - "market_analysis.md"
      - "feasibility_report.md"
      - "HANDOFF.md"
    timeout: 7200  # 2 hours

  - id: "03-planning"
    name: "Planning"
    description: "System architecture and tech stack decisions"
    models: ["gemini"]
    mode: "plan"
    inputs:
      - "tech_research.md"
      - "feasibility_report.md"
    outputs:
      - "architecture.md"
      - "tech_stack.md"
      - "project_plan.md"
      - "HANDOFF.md"
    timeout: 3600

  - id: "04-ui-ux"
    name: "UI/UX Planning"
    description: "User interface and experience design"
    models: ["gemini"]
    mode: "plan"
    inputs:
      - "requirements_analysis.md"
      - "architecture.md"
    outputs:
      - "wireframes.md"
      - "user_flows.md"
      - "design_system.md"
      - "HANDOFF.md"
    timeout: 3600

  - id: "05-task-management"
    name: "Task Management"
    description: "Task breakdown and sprint planning"
    models: ["claudecode"]
    mode: "plan"
    inputs:
      - "project_plan.md"
      - "architecture.md"
    outputs:
      - "tasks.md"
      - "sprint_plan.md"
      - "milestones.md"
      - "HANDOFF.md"
    timeout: 1800  # 30 minutes

  - id: "06-implementation"
    name: "Implementation"
    description: "Core feature implementation"
    models: ["claudecode"]
    mode: "plan_sandbox"
    sandbox: true
    inputs:
      - "tasks.md"
      - "architecture.md"
      - "design_system.md"
    outputs:
      - "source_code/"
      - "implementation_log.md"
      - "HANDOFF.md"
    timeout: 14400  # 4 hours
    checkpoint_required: true

  - id: "07-refactoring"
    name: "Refactoring"
    description: "Code quality improvement and optimization"
    models: ["codex"]
    mode: "deep_dive"
    inputs:
      - "source_code/"
      - "implementation_log.md"
    outputs:
      - "refactored_code/"
      - "refactoring_report.md"
      - "HANDOFF.md"
    timeout: 7200
    checkpoint_required: true

  - id: "08-qa"
    name: "QA"
    description: "Quality assurance and code review"
    models: ["claudecode"]
    mode: "plan_sandbox"
    sandbox: true
    inputs:
      - "refactored_code/"
      - "refactoring_report.md"
    outputs:
      - "qa_report.md"
      - "bug_fixes.md"
      - "HANDOFF.md"
    timeout: 3600

  - id: "09-testing"
    name: "Testing & E2E"
    description: "Test code writing and E2E testing"
    models: ["codex"]
    mode: "sandbox_playwright"
    sandbox: true
    mcp_servers: ["playwright"]
    inputs:
      - "source_code/"
      - "qa_report.md"
    outputs:
      - "tests/"
      - "test_report.md"
      - "coverage_report.md"
      - "HANDOFF.md"
    timeout: 7200

  - id: "10-deployment"
    name: "CI/CD & Deployment"
    description: "Deployment pipeline setup and deployment"
    models: ["claudecode"]
    mode: "headless"
    inputs:
      - "source_code/"
      - "tests/"
      - "test_report.md"
    outputs:
      - ".github/workflows/"
      - "deployment_config/"
      - "deployment_log.md"
    timeout: 3600

# State Management Configuration
state_management:
  progress_file: "state/progress.json"
  checkpoints_dir: "state/checkpoints"
  context_dir: "state/context"
  handoffs_dir: "state/handoffs"

  # Context management thresholds (percentage-based, remaining context)
  # See config/context.yaml for detailed settings
  context_thresholds:
    warning: 60      # 60% remaining - display warning
    action: 50       # 50% remaining - auto-save state
    critical: 40     # 40% remaining - recommend /clear

  # Task-based auto-save
  task_save_frequency: 5  # Save every 5 completed tasks

  # Auto-actions when thresholds are reached
  auto_actions:
    on_warning:      # 60% remaining
      - display_banner
    on_action:       # 50% remaining
      - save_snapshot
      - suggest_compact
    on_critical:     # 40% remaining
      - save_snapshot
      - require_compact

  # Statusline API integration for real-time monitoring
  statusline:
    enabled: true
    script: ".claude/hooks/statusline.sh"
    update_interval_ms: 300

  # Legacy absolute thresholds (deprecated, kept for compatibility)
  context_warning: 50000    # tokens - trigger state save
  context_limit: 80000      # tokens - trigger /clear

  # Automatic behaviors
  auto_checkpoint: true
  auto_handoff: true
  preserve_failed_states: true

# Hook Configuration
hooks:
  pre_stage:
    - "validate_inputs"
    - "check_previous_handoff"
    - "verify_prerequisites"

  post_stage:
    - "generate_handoff"
    - "update_progress"
    - "create_checkpoint"
    - "notify_completion"

# Transition Rules
transitions:
  allow_skip: false
  require_handoff: true
  require_checkpoint:
    - "06-implementation"
    - "07-refactoring"

  # Rollback configuration
  rollback:
    enabled: true
    max_rollback_stages: 2

# Test-First Flow Configuration
# Ensures tests are run at key stages to catch bugs early
test_first_flow:
  enabled: true
  description: "Run tests immediately after implementation/refactoring stages for early bug detection"

  # Stages requiring tests after completion
  test_gates:
    - stage: "06-implementation"
      required_tests:
        - type: "smoke"
          command: "npm run dev"
          description: "Verify dev server starts"
          timeout: 60
        - type: "lint"
          command: "npm run lint"
          description: "Static analysis"
          timeout: 120
        - type: "typecheck"
          command: "npm run typecheck"
          description: "Type checking"
          timeout: 120
        - type: "playwright_smoke"
          command: "npx playwright test --grep @smoke"
          description: "Verify basic UI functionality"
          timeout: 180
          optional: true  # Skip if Playwright not configured
      on_failure:
        action: "block_handoff"
        message: "Tests failed - resolve issues before proceeding with HANDOFF"

    - stage: "07-refactoring"
      required_tests:
        - type: "regression"
          command: "npm run test"
          description: "Run existing tests (regression prevention)"
          timeout: 300
        - type: "lint"
          command: "npm run lint"
          description: "Verify code quality after refactoring"
          timeout: 120
      on_failure:
        action: "warn_and_continue"
        message: "Regression tests failed - attention required"

    - stage: "08-qa"
      required_tests:
        - type: "full_test"
          command: "npm run test"
          description: "Full test suite"
          timeout: 600
        - type: "e2e"
          command: "npx playwright test"
          description: "E2E tests"
          timeout: 600
          optional: true
      on_failure:
        action: "block_handoff"
        message: "QA tests failed - bug fixes required"

  # Test result tracking
  tracking:
    enabled: true
    log_file: "state/test_results.json"
    include_in_handoff: true

  # Notifications
  notifications:
    on_test_failure: true
    on_bug_found: true
    include_stack_trace: true

# Pipeline Forking Configuration
# See config/pipeline_forking.yaml for detailed settings
forking:
  enabled: true

  # Stages where forking is allowed
  fork_points:
    - stage: "03-planning"
      condition: "multiple_architectures_proposed"
      description: "Fork for architecture alternative exploration"

    - stage: "06-implementation"
      condition: "technology_alternatives"
      description: "Fork for tech stack alternative exploration"

  # Fork management
  management:
    max_active_forks: 3
    state_directory: "state/forks"

    # Auto-merge settings
    auto_merge:
      enabled: false
      strategy: "best_performer"

    # Cleanup settings
    cleanup:
      delete_merged_forks: false
      archive_directory: "state/forks/archived"

  # Fork comparison metrics
  comparison:
    enabled: true
    metrics:
      - name: "code_quality"
        weight: 0.4
        command: "npm run lint -- --format json"

      - name: "performance"
        weight: 0.3
        command: "npm run benchmark"

      - name: "maintainability"
        weight: 0.3
        tool: "sonarqube"

  # Integration with commands
  commands:
    create: "/fork create"
    list: "/fork list"
    compare: "/fork compare"
    merge: "/fork merge"
    delete: "/fork delete"

# Iteration/Sprint Support Configuration
# Enables multi-sprint development within Stage 06
iteration:
  enabled: true
  description: "Multi-sprint workflow support within implementation stage"

  # Legacy single-pass mode (default behavior when iteration disabled)
  legacy:
    single_pass_mode: false  # Set to true for backwards compatibility

  # Sprint configuration
  sprints:
    # Definition source for sprints
    source: "stages/05-task-management/outputs/sprint_plan.md"

    # Sprint transition rules
    transition:
      # /next behavior in Stage 06
      next_in_implementation:
        action: "next_sprint"  # Move to next sprint, not next stage
        condition: "all_sprints_completed"  # Only proceed to Stage 07 when all sprints done

      # Manual stage transition command
      force_stage_advance: "/next --force"

    # Sprint completion verification
    verification:
      require_checkpoint: true
      require_tests_passing: true
      commands:
        - "npm run typecheck"
        - "npm run lint"
        - "npm run test:e2e:smoke"

  # Loop-back configuration (returning to previous stages)
  loop_back:
    enabled: true
    description: "Allow intentional return to previous stages for iteration"

    # Allowed loop-back points
    allowed_transitions:
      - from: "07-refactoring"
        to: "06-implementation"
        reason: "Additional feature implementation needed"

      - from: "08-qa"
        to: "06-implementation"
        reason: "Bug fix requiring new implementation"

      - from: "08-qa"
        to: "07-refactoring"
        reason: "Code quality issues requiring refactoring"

    # Loop-back command
    command: "/goto <stage>"

    # Tracking
    tracking:
      enabled: true
      max_loop_backs: 5  # Prevent infinite loops
      log_file: "state/loop_back_history.json"

  # Sprint-specific commands
  commands:
    list_sprints: "/sprint list"
    current_sprint: "/sprint current"
    next_sprint: "/sprint next"  # or "/next --sprint"
    sprint_status: "/sprint status"
