# claude-symphony Pipeline Forking Configuration
# Branch exploration and parallel pipeline execution

pipeline_forking:
  enabled: true
  description: "Explore diverse approaches simultaneously through pipeline forking"

  # Fork point definitions
  fork_points:
    planning_stage:
      stage: "03-planning"
      condition: "multiple_architectures_proposed"
      description: "Fork to explore each architecture when multiple are proposed"
      auto_fork: false
      max_forks: 3

    implementation_stage:
      stage: "06-implementation"
      condition: "alternative_approaches"
      description: "Parallel exploration when multiple implementation approaches exist"
      auto_fork: false
      max_forks: 2

    refactoring_stage:
      stage: "07-refactoring"
      condition: "optimization_tradeoffs"
      description: "Compare when multiple optimization directions exist"
      auto_fork: false
      max_forks: 2

  # Auto fork triggers
  auto_fork_triggers:
    enabled: false  # Manual forking by default

    conditions:
      confidence_threshold:
        enabled: true
        threshold: 0.6  # When confidence is below 60%
        action: "suggest_fork"

      multiple_solutions:
        enabled: true
        minimum_alternatives: 2
        action: "suggest_fork"

      high_risk_decision:
        enabled: true
        risk_indicators:
          - "irreversible"
          - "major_architecture_change"
          - "breaking_change"
        action: "require_fork"

  # Fork management
  fork_management:
    max_active_forks: 3
    naming_convention: "fork_{{stage}}_{{variant}}_{{timestamp}}"

    storage:
      base_path: "state/forks/"
      structure: "isolated"  # isolated or shared

    isolation:
      separate_state: true
      separate_outputs: true
      shared_inputs: true  # Inputs are shared

    # Fork state tracking
    tracking:
      progress: true
      metrics: true
      comparison_points: true

  # Merge strategy
  merge_strategy:
    primary: "best_performer"
    fallback: "manual_selection"

    strategies:
      best_performer:
        description: "Select best performing fork based on metrics"
        criteria:
          - metric: "code_quality"
            weight: 0.3
          - metric: "performance"
            weight: 0.3
          - metric: "maintainability"
            weight: 0.2
          - metric: "test_coverage"
            weight: 0.2

      manual_selection:
        description: "User selects fork directly"
        require_justification: true

      cherry_pick:
        description: "Select optimal parts from multiple forks"
        supported: true
        complexity: "high"

  # Comparison settings
  comparison:
    enabled: true

    metrics:
      code_quality:
        measure: "lint_score"
        higher_is_better: true

      performance:
        measure: "benchmark_time"
        higher_is_better: false

      maintainability:
        measure: "cyclomatic_complexity"
        higher_is_better: false

      test_coverage:
        measure: "coverage_percentage"
        higher_is_better: true

    reporting:
      format: "comparison_table"
      include_recommendations: true

    visualization:
      enabled: true
      chart_types:
        - "radar_chart"
        - "bar_comparison"

# Fork creation process
creation_process:
  steps:
    - name: "validate_fork_point"
      description: "Validate fork point"

    - name: "create_fork_directory"
      description: "Create fork directory"

    - name: "copy_current_state"
      description: "Copy current state"

    - name: "initialize_fork_config"
      description: "Initialize fork configuration"

    - name: "create_fork_handoff"
      description: "Create fork HANDOFF"

    - name: "register_fork"
      description: "Register fork"

  fork_handoff_template: |
    # Fork HANDOFF - {{fork_name}}

    ## Fork Information
    - **Source Stage**: {{source_stage}}
    - **Fork Reason**: {{fork_reason}}
    - **Fork Time**: {{timestamp}}
    - **Exploration Direction**: {{exploration_direction}}

    ## Fork Objectives
    {{objectives}}

    ## Evaluation Criteria
    {{evaluation_criteria}}

    ## Merge Conditions
    {{merge_conditions}}

# Fork execution
execution:
  parallel_execution:
    enabled: true
    max_concurrent: 2

  resource_allocation:
    strategy: "equal"  # equal, priority_based

  synchronization:
    sync_points:
      - "stage_complete"
      - "milestone_reached"

    timeout_minutes: 120  # Maximum fork execution time

# Cleanup policy
cleanup:
  auto_cleanup: true

  cleanup_triggers:
    - after_merge
    - on_abandon
    - on_timeout

  retention:
    keep_merged: true
    keep_abandoned: false
    retention_days: 7

# Notification settings
notifications:
  on_fork_create:
    enabled: true
    message: "Pipeline fork created: {{fork_name}}"

  on_fork_complete:
    enabled: true
    message: "Fork complete: {{fork_name}} - {{status}}"

  on_comparison_ready:
    enabled: true
    message: "Fork comparison ready. {{fork_count}} forks available for comparison"

  on_merge:
    enabled: true
    message: "Fork merge complete: {{selected_fork}} selected"

# Integration settings
integration:
  git:
    create_branches: true
    branch_prefix: "fork/"
    auto_merge: false

  handoff:
    include_fork_info: true
    track_decisions: true

  checkpoint:
    create_before_fork: true
    create_after_merge: true

  memory:
    save_fork_decisions: true
    save_comparison_results: true
