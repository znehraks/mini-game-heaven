# claude-symphony Smart Rollback Configuration
# Intelligent rollback suggestions and execution

smart_rollback:
  enabled: true
  description: "Intelligent rollback suggestions and execution"

  # Rollback suggestions on error
  suggestion:
    on_error:
      enabled: true
      steps:
        - analyze_error_type
        - find_relevant_checkpoint
        - calculate_rollback_scope
        - suggest_recovery_path

    analysis:
      error_patterns:
        build_failure:
          description: "Build failure"
          common_causes: ["dependency", "syntax", "type_error"]
          suggested_scope: "file_level"

        test_failure:
          description: "Test failure"
          common_causes: ["logic_error", "state_change"]
          suggested_scope: "function_level"

        runtime_error:
          description: "Runtime error"
          common_causes: ["null_reference", "type_mismatch"]
          suggested_scope: "file_level"

        configuration_error:
          description: "Configuration error"
          common_causes: ["invalid_config", "missing_env"]
          suggested_scope: "config_only"

    checkpoint_selection:
      strategy: "most_recent_stable"
      fallback: "last_stage_complete"

      scoring:
        recency: 0.4
        stability: 0.4
        relevance: 0.2

  # Partial rollback
  partial_rollback:
    enabled: true
    description: "Selective recovery of affected scope only instead of full rollback"

    granularity:
      file_level:
        description: "Rollback specific files only"
        use_when: ["single_file_error", "isolated_change"]

      function_level:
        description: "Rollback specific functions/methods only"
        use_when: ["logic_error", "refactoring_issue"]
        supported_languages: ["typescript", "javascript", "python"]

      stage_level:
        description: "Rollback entire stage"
        use_when: ["major_failure", "architecture_change"]

      config_only:
        description: "Rollback config files only"
        use_when: ["configuration_error"]
        patterns: ["*.yaml", "*.json", "*.env*"]

    # Dependency analysis
    dependency_analysis:
      enabled: true
      description: "Auto-detect affected files during rollback"

      include_dependents: true
      max_cascade_depth: 3

  # Rollback preview
  rollback_preview:
    enabled: true
    description: "Preview changes before rollback"

    show_diff: true
    show_impact: true
    show_affected_files: true
    show_test_status: true

    require_confirmation: true
    confirmation_prompt: |
      ## Rollback Preview

      **Target Checkpoint**: {{checkpoint_name}}
      **Rollback Scope**: {{scope}}

      ### Affected Files ({{file_count}} files)
      {{affected_files}}

      ### Change Summary
      {{diff_summary}}

      Proceed with this rollback? (y/n)

  # Rollback execution
  execution:
    pre_rollback:
      - create_backup_checkpoint
      - save_current_state
      - notify_rollback_start

    rollback_steps:
      - validate_checkpoint
      - extract_files
      - apply_changes
      - verify_integrity
      - update_state

    post_rollback:
      - run_validation
      - update_handoff
      - notify_completion

    # Failure handling
    on_failure:
      strategy: "restore_backup"
      notify: true
      log_details: true

  # Safety measures
  safety:
    # Rollback prevention conditions
    prevent_rollback_when:
      - uncommitted_changes: true
      - active_processes: true
      - locked_files: true

    # Confirmation required conditions
    require_confirmation_when:
      - scope: "stage_level"
      - files_affected: 10
      - includes_production: true

    # Rollback limits
    limits:
      max_rollback_stages: 2
      max_file_rollbacks: 50
      cooldown_minutes: 5

# Rollback history
history:
  enabled: true
  storage_path: "state/rollback_history/"

  track:
    - timestamp
    - trigger
    - scope
    - affected_files
    - success_status
    - recovery_time

  retention_days: 30

# Recovery guide
recovery_guide:
  enabled: true
  description: "Recovery instructions after rollback"

  templates:
    after_file_rollback: |
      ## File Rollback Complete

      The following files have been restored:
      {{files}}

      ### Recommended Next Steps
      1. Review changes: `git diff`
      2. Run tests: `npm test`
      3. Modify and re-commit as needed

    after_stage_rollback: |
      ## Stage Rollback Complete

      {{stage_id}} has been restored to checkpoint.

      ### Recovery Information
      - Checkpoint: {{checkpoint_name}}
      - Files restored: {{file_count}}

      ### Recommended Next Steps
      1. Review HANDOFF: `stages/{{stage_id}}/HANDOFF.md`
      2. Review tasks
      3. Restart stage

# Integration settings
integration:
  git:
    auto_stash: true
    create_branch: false  # Create rollback branch if true

  handoff:
    update_on_rollback: true
    include_rollback_info: true

  memory:
    save_rollback_decision: true
    observation_type: "bugfix"
